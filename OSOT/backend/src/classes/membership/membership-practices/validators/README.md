# Membership Practices Validators

This directory contains custom class-validator validators for the membership practices entity, providing business rule validation beyond standard decorators.

## Files Overview

### 1. `membership-practices.validators.ts`

Main validator implementations using class-validator's `@ValidatorConstraint` pattern.

**Total Validators**: 10

## Validator Categories

### System Field Validators

#### `PracticeIdValidator`

**Purpose**: Validates business ID format (osot-pra-0000001)

**Pattern**: `osot-pra-` followed by 7 digits

**Usage**: Data migration, bulk imports, testing scenarios

**Note**: Auto-generated by Dataverse in normal operations

#### `MembershipYearPracticesValidator`

**Purpose**: Validates membership year format and range

**Rules**:

- Must be 4-digit integer (YYYY format)
- Range: 2020 to current year + 5
- SYSTEM-DEFINED field (from membership-settings)

**Note**: Users cannot manually set this field

### Conditional "Other" Field Validators

#### `PracticeSettingsOtherValidator`

**Purpose**: Validates conditional "other" description field

**Business Rule**: Required when `osot_practice_settings` contains `PracticeSettings.OTHER`

**Max Length**: 255 characters

**Example**:

```typescript
// Valid: OTHER selected with description
{
  osot_practice_settings: [PracticeSettings.CLIENTS_HOME, PracticeSettings.OTHER],
  osot_practice_settings_other: "Mobile clinic"
}

// Invalid: OTHER selected without description
{
  osot_practice_settings: [PracticeSettings.OTHER],
  osot_practice_settings_other: "" // ERROR: required
}
```

#### `PracticeServicesOtherValidator`

**Purpose**: Validates conditional "other" description field

**Business Rule**: Required when `osot_practice_services` contains `PracticeServices.OTHER`

**Max Length**: 255 characters

### Multi-Select Array Validators

#### `ClientsAgeValidator`

**Purpose**: Validates client age groups served (BUSINESS REQUIRED)

**Rules**:

- Must be non-empty array (minimum 1 value)
- No duplicate values
- All values must be valid `ClientsAge` enum values

**Example**:

```typescript
// Valid
osot_clients_age: [ClientsAge.ADULT, ClientsAge.OLDER];

// Invalid: Empty array
osot_clients_age: []; // ERROR: business required

// Invalid: Duplicates
osot_clients_age: [ClientsAge.ADULT, ClientsAge.ADULT]; // ERROR
```

#### `PracticeAreaValidator`

**Purpose**: Validates practice areas (OPTIONAL)

**Rules**:

- Optional field (can be null/undefined/empty array)
- No duplicate values if provided
- All values must be valid `PracticeArea` enum values

#### `PracticeSettingsValidator`

**Purpose**: Validates practice settings (OPTIONAL)

**Rules**:

- Optional field (can be null/undefined/empty array)
- No duplicate values if provided
- All values must be valid `PracticeSettings` enum values

#### `PracticeServicesValidator`

**Purpose**: Validates practice services (OPTIONAL)

**Rules**:

- Optional field (can be null/undefined/empty array)
- No duplicate values if provided
- All values must be valid `PracticeServices` enum values

### Access Control Validators

#### `PrivilegePracticesValidator`

**Purpose**: Validates privilege level

**Rules**:

- Optional field (defaults to `Privilege.OWNER`)
- Must be valid `Privilege` enum value if provided

**Valid Values**: MAIN, ADMIN, OWNER

#### `AccessModifierPracticesValidator`

**Purpose**: Validates access modifier

**Rules**:

- Optional field (defaults to `AccessModifier.PRIVATE`)
- Must be valid `AccessModifier` enum value if provided

**Valid Values**: PUBLIC, PRIVATE

## Validation Patterns

### Multi-Select Array Validation

All multi-select fields follow this pattern:

1. Check if null/undefined (required vs optional)
2. Handle empty arrays (valid for optional, invalid for required)
3. Check for duplicate values
4. Validate each value against enum

### Conditional "Other" Validation

When enum contains OTHER value:

1. Check if array includes enum.OTHER
2. If yes, corresponding "\_other" field REQUIRED
3. Must be non-empty string after trim()
4. Max 255 characters

## Integration with DTOs

These validators are used in DTOs via `@Validate()` decorator:

```typescript
import { Validate } from 'class-validator';
import { ClientsAgeValidator } from '../validators';

export class CreateMembershipPracticesDto {
  @Validate(ClientsAgeValidator)
  osot_clients_age: ClientsAge[];
}
```

## Best Practices

1. **Required Arrays**: Use `ClientsAgeValidator` - enforces minimum 1 value
2. **Optional Arrays**: Use `PracticeAreaValidator` - allows empty/null
3. **Conditional Fields**: Always validate "other" fields with conditional validators
4. **No Duplicates**: All array validators check for duplicate values
5. **Backward Compatibility**: Validators handle both arrays and single values

## Related Files

- **Constants**: `../constants/membership-practices.constants.ts`
- **Enums**: `../enums/*.enum.ts`
- **DTOs**: `../dtos/*.dto.ts`
- **Interfaces**: `../interfaces/*.interface.ts`

Usage

- Prefer reusing class-validator + custom decorators for request validation.
- Keep complex validation in separate functions to permit unit testing.
