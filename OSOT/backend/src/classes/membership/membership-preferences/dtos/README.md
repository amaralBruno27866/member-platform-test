# Membership Preferences DTOs Documentation

## Overview

This directory contains all Data Transfer Objects (DTOs) for the Membership Preferences module. The DTOs follow a consistent pattern established across the OSOT Dataverse API project and provide comprehensive validation, documentation, and type safety for API operations.

## Architecture

### DTO Hierarchy

```
CreateMembershipPreferenceDto        (User-provided fields only)
         ↓
MembershipPreferenceBasicDto         (All fields including system)
         ↓
UpdateMembershipPreferenceDto        (Extends Basic, requires ID)

MembershipPreferenceResponseDto      (API responses)
ListMembershipPreferencesQueryDto    (Query parameters)
```

## DTOs Reference

### 1. CreateMembershipPreferenceDto

**Purpose**: User-provided fields for preference creation via POST endpoints

**File**: `membership-preference-create.dto.ts`

**Usage Context**:
- POST /private/membership-preferences
- User self-service preference creation
- Annual membership preference configuration
- API integration with user profile management

**Required Fields**:
- `osot_membership_year` (string, 4 digits)
- `osot_auto_renewal` (boolean)
- At least one lookup field (category, account, or affiliate)

**Optional Fields**:
- Lookup: `osot_Table_Membership_Category@odata.bind`
- Lookup: `osot_Table_Account@odata.bind` (XOR with affiliate)
- Lookup: `osot_Table_Account_Affiliate@odata.bind` (XOR with account)
- Choice: `osot_third_parties` (ThirdParties enum)
- Choice: `osot_practice_promotion` (PracticePromotion enum)
- Choice: `osot_members_search_tools` (SearchTools enum)
- Boolean: `osot_shadowing`
- Choice: `osot_psychotherapy_supervision` (PsychotherapySupervision enum)
- Choice: `osot_privilege` (Privilege enum, default: Owner)
- Choice: `osot_access_modifiers` (AccessModifier enum, default: Private)

**Validation Rules**:
1. **Membership Year Validation** (`MembershipYearPreferenceValidator`):
   - Must be 4-digit string
   - Must be valid year format
   - Must be within reasonable range

2. **XOR Validation** (`ExclusiveUserReferencePreferenceValidator`):
   - Account and Affiliate are mutually exclusive
   - Only one can be provided
   - Critical business rule for user reference

3. **Lookup Required** (`LookupRequiredValidator`):
   - At least one lookup field must be provided
   - Category, Account, or Affiliate required

4. **Enum Validators**:
   - `ThirdPartiesValidator`: Validates against ThirdParties enum
   - `PracticePromotionValidator`: Validates against PracticePromotion enum
   - `SearchToolsValidator`: Validates against SearchTools enum
   - `PsychotherapySupervisionValidator`: Validates against PsychotherapySupervision enum

5. **Boolean Validators**:
   - `AutoRenewalValidator`: Required boolean for auto-renewal preference
   - `ShadowingValidator`: Optional boolean for shadowing participation

6. **Access Control Validators**:
   - `PrivilegePreferenceValidator`: Validates privilege level
   - `AccessModifiersPreferenceValidator`: Validates access modifier

**Example**:
```typescript
{
  "osot_membership_year": "2025",
  "osot_auto_renewal": false,
  "osot_Table_Membership_Category@odata.bind": "/osot_table_membership_categories/a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "osot_Table_Account@odata.bind": "/osot_table_accounts/b1a2c3d4-e5f6-7890-abcd-1234567890ef",
  "osot_third_parties": 1,
  "osot_practice_promotion": 1,
  "osot_members_search_tools": 1,
  "osot_shadowing": false,
  "osot_psychotherapy_supervision": 3,
  "osot_privilege": 3,
  "osot_access_modifiers": 2
}
```

---

### 2. MembershipPreferenceBasicDto

**Purpose**: Complete entity representation with all fields including system-generated ones

**File**: `membership-preference-basic.dto.ts`

**Usage Context**:
- Extended by Update DTO for PATCH operations
- Internal service layer processing
- Mapping between Dataverse and Internal representations
- Full entity state management

**Additional Fields** (compared to Create DTO):
- `osot_preference_id` (UUID, primary key)
- `osot_preference` (string, business identifier: osot-pref-NNNNNNN)
- `osot_table` (string, always "osot_table_membership_preferences")
- `createdon` (Date, auto-generated)
- `modifiedon` (Date, auto-managed)

**System Fields**:
All system fields are optional for create operations and auto-generated by Dataverse:
- Preference ID format: `osot-pref-0000001` (auto-incremented)
- UUID primary key (version 4)
- Timestamps in UTC timezone

**Validation**:
- Includes all validators from Create DTO
- Additional `PreferenceIdValidator` for business identifier format

---

### 3. UpdateMembershipPreferenceDto

**Purpose**: Update operations requiring preference ID

**File**: `membership-preference-update.dto.ts`

**Usage Context**:
- PATCH /private/membership-preferences/:id
- User preference updates during membership renewal
- Admin preference corrections
- Annual preference modifications

**Key Difference**:
- Extends `MembershipPreferenceBasicDto`
- Overrides `osot_preference_id` to make it **required**
- Supports partial updates (all other fields remain optional)

**Business Rules**:
- Preference ID is required for all update operations
- User-year combination must remain unique after update
- Account/Affiliate XOR rule still applies
- Cannot change business identifier (`osot_preference`) after creation
- All other fields follow same validation as Basic DTO

**Example**:
```typescript
{
  "osot_preference_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "osot_membership_year": "2026",
  "osot_auto_renewal": true,
  "osot_third_parties": 2
}
```

---

### 4. MembershipPreferenceResponseDto

**Purpose**: Clean API response structure for GET endpoints

**File**: `membership-preference-response.dto.ts`

**Usage Context**:
- GET /private/membership-preferences/:id (single record)
- GET /private/membership-preferences (list endpoint)
- POST response after creation (returns created entity)
- PATCH response after update (returns updated entity)
- All API responses requiring full entity data

**Key Features**:
- No validators (validation happens on input, not output)
- All fields are optional
- Includes expanded navigation properties
- Lookup fields returned as `_field_value` format
- Enums returned as numeric values
- Timestamps in ISO 8601 format

**Lookup Response Format**:
Instead of OData binds, lookups are returned as:
- `_osot_table_membership_category_value` (UUID)
- `_osot_table_account_value` (UUID)
- `_osot_table_account_affiliate_value` (UUID)

**Expanded Navigation Properties** (when $expand is used):
- `osot_Table_Membership_Category`: Full category object
- `osot_Table_Account`: Full account object
- `osot_Table_Account_Affiliate`: Full affiliate object

**Example**:
```typescript
{
  "osot_preference_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "osot_preference": "osot-pref-0000001",
  "osot_table": "osot_table_membership_preferences",
  "osot_membership_year": "2025",
  "osot_auto_renewal": false,
  "_osot_table_membership_category_value": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "_osot_table_account_value": "b1a2c3d4-e5f6-7890-abcd-1234567890ef",
  "osot_third_parties": 1,
  "osot_practice_promotion": 1,
  "osot_members_search_tools": 1,
  "osot_shadowing": false,
  "osot_psychotherapy_supervision": 3,
  "osot_privilege": 3,
  "osot_access_modifiers": 2,
  "createdon": "2025-01-15T10:30:00Z",
  "modifiedon": "2025-01-20T14:45:00Z"
}
```

---

### 5. ListMembershipPreferencesQueryDto

**Purpose**: Query parameters for filtering, sorting, and pagination

**File**: `list-membership-preferences.query.dto.ts`

**Usage Context**:
- GET /private/membership-preferences (list with filters)
- Administrative dashboards for preferences management
- Reporting and analytics queries
- Annual preference review and bulk operations

**Query Capabilities**:

#### Primary Filters:
- `membershipYear` (string): Filter by year (e.g., "2025")
- `membershipCategoryId` (UUID): Filter by category GUID
- `accountId` (UUID): Filter by account GUID
- `affiliateId` (UUID): Filter by affiliate GUID

#### Preference-Specific Filters:
- `autoRenewal` (boolean): Filter by auto-renewal preference
- `thirdParties` (ThirdParties enum): Filter by third parties preference
- `practicePromotion` (PracticePromotion enum): Filter by practice promotion
- `searchTools` (SearchTools enum): Filter by search tools preference
- `shadowing` (boolean): Filter by shadowing participation
- `psychotherapySupervision` (PsychotherapySupervision enum): Filter by supervision type

#### Access Control Filters:
- `privilege` (Privilege enum): Filter by privilege level
- `accessModifier` (AccessModifier enum): Filter by access modifier

#### Search:
- `searchTerm` (string): Partial match on preference ID pattern

#### Sorting:
- `sortBy`: Field to sort by (any preference field)
- `sortOrder`: ASC or DESC

#### Pagination:
- `page` (number, min: 1): Page number (1-based)
- `pageSize` (number, min: 1, max: 100): Items per page

#### Date Range:
- `createdFrom` (string, date format): Filter by creation date (from)
- `createdTo` (string, date format): Filter by creation date (to)

**Example Query**:
```
GET /private/membership-preferences?membershipYear=2025&autoRenewal=true&sortBy=createdon&sortOrder=DESC&page=1&pageSize=25
```

---

## Business Rules Summary

### 1. Account/Affiliate XOR Rule
- **Rule**: Account and Affiliate lookups are mutually exclusive
- **Validator**: `ExclusiveUserReferencePreferenceValidator`
- **Impact**: Only one user reference can be provided per preference
- **Error**: Returns validation error if both are provided

### 2. Lookup Required Rule
- **Rule**: At least one lookup field must be provided
- **Validator**: `LookupRequiredValidator`
- **Options**: Category, Account, or Affiliate
- **Error**: Returns validation error if no lookup is provided

### 3. User-Year Uniqueness
- **Rule**: Combination of user (Account/Affiliate) and year must be unique
- **Validation**: Service layer (not DTO level)
- **Impact**: Prevents duplicate preferences for same user in same year
- **Error**: Returns conflict error (409) if duplicate exists

### 4. Default Values
- **Privilege**: Defaults to `Privilege.OWNER` (3) if not provided
- **Access Modifier**: Defaults to `AccessModifier.PRIVATE` (2) if not provided
- **Auto Renewal**: No default (must be explicitly provided)

---

## Integration Points

### Validators Used
All validators are defined in `validators/membership-preference.validators.ts`:
1. `MembershipYearPreferenceValidator`
2. `ExclusiveUserReferencePreferenceValidator`
3. `LookupRequiredValidator`
4. `ThirdPartiesValidator`
5. `PracticePromotionValidator`
6. `SearchToolsValidator`
7. `PsychotherapySupervisionValidator`
8. `ShadowingValidator`
9. `AutoRenewalValidator`
10. `PrivilegePreferenceValidator`
11. `AccessModifiersPreferenceValidator`
12. `PreferenceIdValidator`

### Enums Used

**Global Enums** (from `common/enums`):
- `Privilege`: MAIN (1), ADMIN (2), OWNER (3)
- `AccessModifier`: PUBLIC (1), PRIVATE (2), PUBLIC_NO_EDIT (3)

**Local Enums** (from `enums/`):
- `ThirdParties`: RECRUITMENT (1), PRODUCT (2), PROFESSIONAL_DEVELOPMENT (3)
- `PracticePromotion`: SELF (1), EMPLOYER (2)
- `SearchTools`: PROFESSIONAL_NETWORKS (1), POTENTIAL_MENTORING (2), SUPERVISING_CLINIC_PLACEMENTS (3), EXAM_MENTORING (4)
- `PsychotherapySupervision`: 15 different therapy approaches (1-15)

### Constants Used
From `constants/membership-preference.constants.ts`:
- `MEMBERSHIP_PREFERENCE_FIELDS`: Field mappings
- `MEMBERSHIP_PREFERENCE_ODATA`: OData configurations
- `MEMBERSHIP_PREFERENCES_PERMISSIONS`: Permission configurations
- `MEMBERSHIP_PREFERENCE_BUSINESS_RULES`: Business logic rules
- `MEMBERSHIP_PREFERENCE_ERROR_CODES`: Error code mappings

---

## Usage Examples

### Creating a New Preference

```typescript
import { CreateMembershipPreferenceDto } from './dtos';

const createDto: CreateMembershipPreferenceDto = {
  osot_membership_year: '2025',
  osot_auto_renewal: false,
  'osot_Table_Membership_Category@odata.bind': '/osot_table_membership_categories/a1b2c3d4-e5f6-7890-abcd-ef1234567890',
  'osot_Table_Account@odata.bind': '/osot_table_accounts/b1a2c3d4-e5f6-7890-abcd-1234567890ef',
  osot_third_parties: ThirdParties.RECRUITMENT,
  osot_practice_promotion: PracticePromotion.SELF,
  osot_members_search_tools: SearchTools.PROFESSIONAL_NETWORKS,
  osot_shadowing: false,
  osot_psychotherapy_supervision: PsychotherapySupervision.COGNITIVE_BEHAVIOURAL,
  osot_privilege: Privilege.OWNER,
  osot_access_modifiers: AccessModifier.PRIVATE
};

// POST /private/membership-preferences
```

### Updating an Existing Preference

```typescript
import { UpdateMembershipPreferenceDto } from './dtos';

const updateDto: UpdateMembershipPreferenceDto = {
  osot_preference_id: 'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
  osot_membership_year: '2026',
  osot_auto_renewal: true,
  osot_third_parties: ThirdParties.PROFESSIONAL_DEVELOPMENT
};

// PATCH /private/membership-preferences/a1b2c3d4-e5f6-7890-abcd-ef1234567890
```

### Querying Preferences

```typescript
import { ListMembershipPreferencesQueryDto } from './dtos';

const queryDto: ListMembershipPreferencesQueryDto = {
  membershipYear: '2025',
  autoRenewal: true,
  accountId: 'b1a2c3d4-e5f6-7890-abcd-1234567890ef',
  sortBy: 'createdon',
  sortOrder: 'DESC',
  page: 1,
  pageSize: 25
};

// GET /private/membership-preferences?membershipYear=2025&autoRenewal=true&...
```

---

## Swagger Documentation

All DTOs are fully documented with:
- `@ApiProperty` decorators on all fields
- Example values for each field
- Field descriptions with business context
- Required/optional status
- Enum options when applicable
- Format specifications (UUID, date-time, etc.)

The Swagger UI will automatically generate:
- Interactive API documentation
- Request/response examples
- Schema definitions
- Validation rules display

---

## Related Documentation

- [Membership Preferences Constants](../constants/README.md) - Field mappings, OData config, permissions
- [Membership Preferences Validators](../validators/README.md) - Business rule validators
- [Membership Preferences Interfaces](../interfaces/README.md) - Type definitions
- [Membership Preferences Enums](../enums/README.md) - Choice field enums
- [PADRAO_UPDATE_SERVICE.md](../../../../documentation/PADRAO_UPDATE_SERVICE.md) - Service layer patterns

---

**Last Updated**: January 2025  
**Version**: 1.0.0  
**Status**: Production Ready
