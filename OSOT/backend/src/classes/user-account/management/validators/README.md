# Management Validators

## Purpose

Contains custom validation logic used by DTOs and services for Account Management. Validators implement business rules, data integrity constraints, and cross-field validation specific to management operations including flag combinations, lifecycle rules, and administrative access control.

## üìÅ Validator Structure

### Core Validators

- **Basic Field Validators**: User Business ID format, Account Management ID validation
- **Business Rule Validators**: Mutual exclusivity, flag combinations, lifecycle constraints
- **Access Control Validators**: Privilege levels, access modifiers validation
- **Comprehensive Validators**: Complete business rule validation in single decorator

## üìã Available Validators

### **1. Basic Field Validators**

#### **`@IsManagementUserBusinessId()`**

Validates User Business ID format and length requirements.

**Business Rules:**

- **Required Field** (CSV: Business requires)
- **Length**: 1-20 characters
- **Pattern**: Alphanumeric with dashes and underscores only
- **Format**: `/^[a-zA-Z0-9_-]+$/`

**Usage:**

```typescript
export class CreateManagementDto {
  @IsManagementUserBusinessId()
  osot_user_business_id: string;
}
```

#### **`@IsAccountManagementIdFormat()`**

Validates auto-generated Account Management ID format.

**Business Rules:**

- **Optional Field** (auto-generated by system)
- **Pattern**: `osot-am-0000001` format
- **Format**: `/^osot-am-\d{7}$/`

**Usage:**

```typescript
export class ManagementResponseDto {
  @IsAccountManagementIdFormat()
  osot_account_management_id?: string;
}
```

### **2. Business Rule Validators**

#### **`@IsVendorRecruitmentValid()`**

Validates mutual exclusivity between vendor and recruitment flags.

**Business Rule:**

- **Vendors cannot have recruitment permissions**
- **Cross-field validation**: `vendor: true` requires `recruitment: false`

**Usage:**

```typescript
export class ManagementDto {
  osot_vendor?: boolean;

  @IsVendorRecruitmentValid()
  osot_recruitment?: boolean;
}
```

#### **`@IsLifecycleFlagValid()`**

Validates lifecycle flag combinations for member status.

**Business Rules:**

- **Cannot be both passed away and life member retired**
- **Mutual exclusivity**: `passed_away` vs `life_member_retired`

**Usage:**

```typescript
export class ManagementDto {
  osot_passed_away?: boolean;

  @IsLifecycleFlagValid()
  osot_life_member_retired?: boolean;
}
```

#### **`@IsActiveServiceValid()`**

Validates that deceased members cannot have active services.

**Business Rules:**

- **Deceased members cannot offer services**
- **Affected services**: shadowing, vendor, advertising, recruitment, driver_rehab
- **Lifecycle constraint**: `passed_away: true` requires all services to be `false`

**Usage:**

```typescript
export class ManagementDto {
  osot_passed_away?: boolean;

  @IsActiveServiceValid()
  osot_shadowing?: boolean;
}
```

### **3. Access Control Validators**

#### **`@IsValidAccessModifier()`**

Validates Access Modifier enum values.

**Business Rules:**

- **Enum Values**: `PUBLIC`, `PROTECTED`, `PRIVATE`
- **Default**: `PROTECTED` (CSV specification)
- **Optional Field**

**Usage:**

```typescript
export class ManagementDto {
  @IsValidAccessModifier()
  @IsEnum(AccessModifier)
  osot_access_modifiers?: AccessModifier;
}
```

#### **`@IsValidPrivilege()`**

Validates Privilege enum values.

**Business Rules:**

- **Enum Values**: `OWNER`, `ADMIN`, `MAIN`
- **Default**: `OWNER` (CSV specification)
- **Sensitive Field** (internal use only)

**Usage:**

```typescript
export class ManagementInternalDto {
  @IsValidPrivilege()
  @IsEnum(Privilege)
  osot_privilege?: Privilege;
}
```

### **4. Comprehensive Validator**

#### **`@IsManagementBusinessRulesValid()`**

Validates all management business rules in a single comprehensive check.

**Validates:**

- **Vendor-Recruitment Exclusivity**
- **Lifecycle Flag Combinations**
- **Active Service Constraints**
- **All cross-field business rules**

**Usage:**

```typescript
export class ManagementDto {
  // ... all management fields

  @IsManagementBusinessRulesValid()
  _businessRulesValid?: boolean; // Trigger field for validation
}
```

## üîß Integration Patterns

### **DTO Integration**

```typescript
import {
  IsManagementUserBusinessId,
  IsVendorRecruitmentValid,
  IsLifecycleFlagValid,
  IsActiveServiceValid,
} from './validators';

export class CreateManagementDto {
  @IsManagementUserBusinessId()
  osot_user_business_id: string;

  @IsOptional()
  @IsBoolean()
  osot_vendor?: boolean;

  @IsOptional()
  @IsBoolean()
  @IsVendorRecruitmentValid()
  osot_recruitment?: boolean;

  @IsOptional()
  @IsBoolean()
  osot_passed_away?: boolean;

  @IsOptional()
  @IsBoolean()
  @IsLifecycleFlagValid()
  @IsActiveServiceValid()
  osot_shadowing?: boolean;
}
```

### **Service Integration**

```typescript
import { validateManagementBusinessRules } from './validators';

export class ManagementBusinessRuleService {
  async validateForCreation(
    data: CreateManagementDto,
  ): Promise<ValidationResult> {
    // Use utility function for programmatic validation
    const businessRulesResult = validateManagementBusinessRules(data);

    return {
      isValid: businessRulesResult.isValid,
      errors: businessRulesResult.errors,
      warnings: businessRulesResult.warnings,
    };
  }
}
```

### **Access Control Integration**

```typescript
import { validatePrivilegeLevel } from './validators';

export class ManagementAccessService {
  canUpdateManagement(userPrivilege: Privilege): boolean {
    return validatePrivilegeLevel(userPrivilege, 'UPDATE');
  }

  canDeleteManagement(userPrivilege: Privilege): boolean {
    return validatePrivilegeLevel(userPrivilege, 'DELETE');
  }
}
```

## üõ°Ô∏è Business Rules Enforced

### **Flag Combination Rules**

| Scenario                   | Rule             | Validator                     |
| -------------------------- | ---------------- | ----------------------------- |
| Vendor + Recruitment       | ‚ùå **Forbidden** | `@IsVendorRecruitmentValid()` |
| Passed Away + Life Member  | ‚ùå **Forbidden** | `@IsLifecycleFlagValid()`     |
| Deceased + Active Services | ‚ùå **Forbidden** | `@IsActiveServiceValid()`     |
| Vendor + Advertising       | ‚úÖ **Allowed**   | No restriction                |
| Shadowing + Recruitment    | ‚úÖ **Allowed**   | No restriction                |

### **Lifecycle Constraints**

```typescript
// ‚ùå Invalid combinations
{
  osot_vendor: true,
  osot_recruitment: true,        // Error: Vendors cannot recruit
}

{
  osot_passed_away: true,
  osot_life_member_retired: true, // Error: Cannot be both
}

{
  osot_passed_away: true,
  osot_shadowing: true,          // Error: Deceased cannot offer services
}

// ‚úÖ Valid combinations
{
  osot_vendor: true,
  osot_advertising: true,        // OK: Vendors can advertise
}

{
  osot_life_member_retired: true,
  osot_shadowing: false,         // OK: Retired member, no services
}
```

### **Access Control Levels**

| Operation           | Owner | Admin | Main |
| ------------------- | ----- | ----- | ---- |
| **Read**            | ‚úÖ    | ‚úÖ    | ‚ùå   |
| **Create**          | ‚úÖ    | ‚úÖ    | ‚ùå   |
| **Update**          | ‚úÖ    | ‚úÖ    | ‚ùå   |
| **Delete**          | ‚úÖ    | ‚ùå    | ‚ùå   |
| **Bulk Operations** | ‚úÖ    | ‚ùå    | ‚ùå   |

## üöÄ Utility Functions

### **`validateManagementBusinessRules()`**

Programmatic validation for service layer use.

```typescript
const validation = validateManagementBusinessRules({
  osot_vendor: true,
  osot_recruitment: true,
});

console.log(validation);
// {
//   isValid: false,
//   errors: ['Vendors cannot have recruitment permissions'],
//   warnings: []
// }
```

### **`validatePrivilegeLevel()`**

Access control validation for administrative operations.

```typescript
const canUpdate = validatePrivilegeLevel(Privilege.ADMIN, 'UPDATE');
console.log(canUpdate); // true

const canDelete = validatePrivilegeLevel(Privilege.ADMIN, 'DELETE');
console.log(canDelete); // false (only OWNER can delete)
```

## üìä Error Messages

### **Standard Error Messages**

- **User Business ID**: "User Business ID must be 1-20 alphanumeric characters, underscores, or hyphens"
- **Vendor-Recruitment**: "Vendors cannot have recruitment permissions"
- **Lifecycle**: "Cannot be both passed away and life member retired"
- **Active Services**: "Deceased members cannot have active [service] service"
- **Access Modifier**: "Access Modifier must be one of: PUBLIC, PROTECTED, PRIVATE"
- **Privilege**: "Privilege must be one of: OWNER, ADMIN, MAIN"

### **Dynamic Error Messages**

The comprehensive validator provides context-specific error messages based on the specific business rule violation detected.

## üîÑ Integration Points

### **Constants Integration**

```typescript
// Uses validation rules from constants
const maxLength = MANAGEMENT_VALIDATION.USER_BUSINESS_ID.MAX_LENGTH;
const pattern = MANAGEMENT_VALIDATION.USER_BUSINESS_ID.PATTERN;
const businessRules = MANAGEMENT_BUSINESS_RULES.EXCLUSIVE_FLAGS;
```

### **Enums Integration**

```typescript
// Validates against proper enum values
const isValidModifier = Object.values(AccessModifier).includes(modifier);
const isValidPrivilege = Object.values(Privilege).includes(privilege);
```

### **DTOs Integration**

```typescript
// Applied as decorators in DTO classes
@IsManagementUserBusinessId()
@IsVendorRecruitmentValid()
@IsLifecycleFlagValid()
```

### **Services Integration**

```typescript
// Used in business logic validation
const validation = validateManagementBusinessRules(managementData);
if (!validation.isValid) {
  throw new ValidationException(validation.errors);
}
```

## üìö Usage Guidelines

### **DTO Validation**

- Use validators as decorators on DTO properties
- Combine with standard `class-validator` decorators
- Apply business rule validators to trigger fields

### **Service Validation**

- Use utility functions for programmatic validation
- Validate before persistence operations
- Check access control before administrative operations

### **Error Handling**

- Implement proper validation for business rule violations
- Provide meaningful error messages for constraint failures
- Log administrative actions for audit purposes

### **Testing**

- Test all business rule combinations
- Verify error message accuracy
- Test edge cases and boundary conditions

---

**üí° Keep validators synchronized with business requirements and constants definitions.**
